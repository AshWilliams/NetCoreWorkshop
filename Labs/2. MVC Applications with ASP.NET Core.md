# Introducción al Routing & MVC

## MVC 101

### Crear una nueva ASP.NET Core Web Application

1. Abrir Visual Studio 2019
1. Crear una nueva ASP.NET Core application:
  1. File -> New -> Project -> ASP.NET Core Web Application (C#)
  2. Despues de nombrar el proyecto, seleccionen la versión de .NET Core y ASP.NET Core 2.2 en los dropdowns
  3. Seleccionen `Web Application (Model-View-Controller)` y cambien el método de autenticación a `Individual User Accounts`.

### Scaffolding-Generar un controlador completo a partir de un nuevo modelo

1. Click derecho en el directorio `Models` y seleccionar `Add`, y luego seleccionar `Class`. Nombren la nueva clase como `Person.cs` con los siguientes atributos:

   ```c#
    public class Persona
    {
        public int ID { get; set; }
        public string Nombre { get; set; }
        public int Edad { get; set; }
    }
   ```

2. Click derecho en el directorio `Controllers` y seleccionen Add -> Controller -> MVC Controller with views, Using Entity Framework.
3. Seleccionar `Persona` as the **Model Class**.
4. Crear un nuevo **Data context class** dandole click al botón `+`.
5. Click **Add** para que genere el control y las vistas de forma automática en base al modelo Persona.
6. Revisar el archivo `appsettings.json` en `ConnectionStrings`, tomen nota del nombre de la base de datos.
7. Desde el `SQL Server Object Explorer`, en `(localdb)`, luego en `Databases`, click derecho a la opción `Add New Database` y le dan el mismo nombre que tomaron nota en el paso anterior.

### Correr Migraciones de EF para actualizar la base de datos con el nuevo modelo Person 

1. Mostrar la ventana del **Package Manager Console** seleccionando View -> Other Windows -> Package Manager Console
2. Crear una nueva migración para el modelo Person class tipeando en la consola `Add-Migration "Persona class"`
3. Actualice la base de datos utilizando esta migración escribiendo `Update-Database`
4. Ejecute la aplicación y navegue a `/Persona` desde la raíz de su aplicación (e.g. `http://localhost:61496/Persona`)
5. Intenta crear una persona con una edad no válida (e.g. "morada")  para observar que la validación de formularios funciona.
5. Cree una persona válida ingresando un nombre y una edad entera.

> **Note:** Una vez termines la actividad el código completo lo subiré a [/Labs/Code/Lab2A](/Labs/Code/Lab2A).

### Extra
1. Añadir un [Validation Attribute](https://docs.microsoft.com/en-us/aspnet/core/mvc/models/validation#validation-attributes) al modelo `Person` para que la edad quede en un rango entre 1 y 120. *cuando hagan esto, recuerden añadir y correr una nueva migración como en el paso anterior.*
1. Usando [Attribute Routing](https://docs.microsoft.com/en-us/aspnet/core/mvc/controllers/routing#attribute-routing), una ruta adicional, que le permita navegar a la accción `Index` del controlador `PeopleController` usando `http://localhost:[port]/Everyone`.

### Scaffolding-Generar un controlador completo a partir de un nuevo modelo

1. Click derecho en el directorio `Models` y seleccionar `Add`, y luego seleccionar `Class`. Nombren la nueva clase como `Person.cs` con los siguientes atributos:

   ```c#
    public class Producto
    {
        public int ID { get; set; }
        public string Nombre { get; set; }
        public string Descripcion { get; set; }
        public int Stock { get; set; }
    }
   ```

2. Click derecho en el directorio `Controllers` y seleccionen Add -> Controller -> MVC Controller with views, Using Entity Framework.
3. Seleccionar `Producto` as the **Model Class**.
4. Crear un nuevo **Data context class** dandole click al botón `+`.
5. Click **Add** to scaffold the controller and views for the Producto model.
6. Revisar el archivo `appsettings.json` en `ConnectionStrings`, tomen nota del nombre de la base de datos.
7. Desde el `SQL Server Object Explorer`, en `(localdb)`, luego en `Databases`, click derecho a la opción `Add New Database` y le dan el mismo nombre que tomaron nota en el paso anterior.

### Correr Migraciones de EF para actualizar la base de datos con el nuevo modelo Person 

1. Mostrar la ventana del **Package Manager Console** seleccionando View -> Other Windows -> Package Manager Console
2. Crear una nueva migración para el modelo Person class tipeando en la consola `Add-Migration "Producto class"`
3. Actualice la base de datos utilizando esta migración escribiendo `Update-Database`
4. Ejecute la aplicación y navegue a `/Producto` desde la raíz de su aplicación (e.g. `http://localhost:61496/Producto`)
5. Intenta crear un producto con un stock no válido (e.g. "morada") para observar que la validación de formularios funciona.
5. Cree un producto válido.

> **Note:** Una vez termines la actividad el código completo lo subiré a [/Labs/Code/Lab2A](/Labs/Code/Lab2A).

## Using Routing in an Empty Web Application

### Create a new Empty ASP.NET Core application

1. Open Visual Studio 2019
1. Create a new ASP.NET Core application:
  1. File -> New -> Project -> ASP.NET Core Web Application (C#)
  2. After naming the project, set the dropdowns to .NET Core and ASP.NET Core 2.2 and select the Empty template.

### Configure the routing package
1. Open the `Startup.cs` file
1. Add the routing services to the configuration in the `Startup.cs`:

   ``` c#
   public void ConfigureServices(IServiceCollection services)
   {
       services.AddRouting();
   }
   ```

1. In the `Configure` method, create a `RouteBuilder` with a handler for the root of the site and add it to the middleware pipeline:
  
   ``` c#
   using Microsoft.AspNetCore.Routing;
   ...
   public void Configure(IApplicationBuilder app, IHostingEnvironment env)
   {
       if (env.IsDevelopment())
       {
           app.UseDeveloperExceptionPage();
       }

       var routeBuilder = new RouteBuilder(app);

       routeBuilder.MapGet("", context => context.Response.WriteAsync("Hello from Routing!"));

       app.UseRouter(routeBuilder.Build());
   }
   ```

1. Run the site and verify your middleware is hit via routing (Ctrl+F5)
1. Add another route that matches a sub-path:
  
   ``` c#
   routeBuilder.MapGet("sub", context => context.Response.WriteAsync("Hello from sub!"));
   ```

1. Run the site and verify that your routes are hit for the corresponding URLs. Browsing to /sub (e.g. http://localhost:8081/sub) should display the message "Hello from sub!"

### Capture and use route data
1. Add another route that captures the name of an item from the URL, e.g. "item/{itemName}", and displays it in the response:
  
   ``` c#
   routeBuilder.MapGet("item/{itemName}", context => context.Response.WriteAsync($"Item: {context.GetRouteValue("itemName")}"));
   ```
1. Run the site and verify that your new route works. Browsing to "/item/monkey" should display the message "Item: monkey".
1. Modify the route to include a route constraint on the captured segment, enforcing it to be a number:
  
   ``` c#
   routeBuilder.MapGet("item/{id:int}", context => context.Response.WriteAsync($"Item ID: {context.GetRouteValue("id")}"));
   ```
1. Run the site again and see that the route is only matched when the captured segment is a valid number. Browsing to "/item/5" will work, but browsing to "/item/monkey" will now show a missing page (HTTP 404) error.
1. Modify the router to include both versions of the route above (with and without the route constraint)
1. Experiment with changing the order the routes are added and observe what affect that has on which route is matched for a given URL

> **Note:** Completed code for this section is found [/Labs/Code/Lab2B](/Labs/Code/Lab2B).

## Add MVC to an Empty Web Application
1. Add a "Controllers" folder to your application
1. Create a new class called "HomeController" in the new folder and add the following code:

    ``` c#
    using Microsoft.AspNetCore.Mvc;
    
    public class HomeController
    {
      [HttpGet("/")]
      public string Index() => "Hello from MVC!";
    }
    ```
1. Replace the Routing middleware from the previous step with MVC services and middleware in `Startup.cs` as shown:

   ``` c#
   public void ConfigureServices(IServiceCollection services)
   {
       services.AddMvc().SetCompatibilityVersion(CompatibilityVersion.Version_2_2);
   }
  
   public void Configure(IApplicationBuilder app, IHostingEnvironment env)
   {
       if (env.IsDevelopment())
       {
           app.UseDeveloperExceptionPage();
       }

       app.UseMvc();
   }
   ```

1. Run the site and verify the message is returned from your MVC controller
1. If you have time, try the following:
  - Change the controller to render a view instead of returning a string directly
  - Play with the `[HttpGet("/")]` attribute to change the route the action method will match

> **Note:** Completed code for this section is found [/Labs/Code/Lab2C](/Labs/Code/Lab2C).
